# Project Rules

- Do not install anything without asking
- Use ui building block components in /src/lib/components/ui, which are generated by the retroui svelte. If you think you need a new component, ask for me to install it
- Always use arrow functions; no `function` keyword unless strictly necessary

# Project Overview

AI Office Hour - An AI tutoring application where students can interact with an AI teaching assistant. The app has a split view: document editor on the left, chat panel on the right.

## Tech Stack

- **Framework**: SvelteKit with Svelte 5 (runes: `$state`, `$derived`, `$effect`, `$props`)
- **AI**: Vercel AI SDK (`ai` package) with Anthropic Claude
- **Editor**: TipTap rich text editor with `svelte-tiptap`
- **UI Components**: bits-ui + Tailwind CSS + tailwind-variants (RetroUI style)
- **Icons**: @lucide/svelte

## Key Architecture

### Document Editor (`src/lib/components/sections/document/`)

TipTap editor with custom node extensions in `extensions/` folder:

- **CardNode** - Wraps content in a Card UI component
- **CommentNode** - Inline comments with hover popup
- **LatexNode** - LaTeX math rendering with KaTeX
- **ResponseNode** - Interactive answer blocks for student responses

#### Creating TipTap Extensions

Two patterns used:

1. **SvelteNodeViewRenderer** (CardNode, ResponseNode) - For complex UI
   ```typescript
   addNodeView() {
     return SvelteNodeViewRenderer(MyNodeView);
   }
   ```
   Use `NodeViewWrapper` and `NodeViewContent` in the Svelte component.

2. **Manual DOM** (CommentNode, LatexNode) - For simple nodes with external popups
   ```typescript
   addNodeView() {
     return ({ node }) => {
       const dom = document.createElement("span");
       // Set up event listeners, update shared state
       return { dom, contentDOM };
     };
   }
   ```

#### State Bridges for Extensions

Extensions communicate with other components via reactive state stores:
- `commentState` in `comment/comment.svelte.ts`
- `latexState` in `latex/latex.svelte.ts`
- `responseState` in `response/response.svelte.ts`

### Chat System (`src/lib/components/sections/chat/`)

- **ChatPanel.svelte** - Main chat component using `Chat` from `@ai-sdk/svelte`
- **ChatInput.svelte** - Message input component

#### Tool Execution Pattern

Tools are defined in `src/lib/tools.ts` and executed client-side in `ChatPanel.svelte`:

```typescript
const chat = new Chat({
  async onToolCall({ toolCall }) {
    if (toolCall.toolName === "my_tool") {
      // Execute tool, modify state
      documentContent = doSomething(documentContent, toolCall.input);
      chat.addToolOutput({
        tool: "my_tool",
        toolCallId: toolCall.toolCallId,
        output: { success: true },
      });
    }
  },
});
```

#### Available Tools

1. **edit_document** - Search/replace text in document
2. **generate_options** - Create clickable follow-up options
3. **update_response** - Update response block status after reviewing student answer

### Prompts (`src/lib/constants/prompts/`)

- `style.prompt.ts` - Persona, tone, teaching approach
- `system.prompt.ts` - Tool usage specs, document format, response block usage
- `index.ts` - Assembles `TUTOR_PROMPT` from all components

### Views (`src/lib/components/sections/views/`)

- **TutoringView.svelte** - Main container wiring DocumentEditor and ChatPanel together

## Response Block System

Interactive answer blocks for students:

**HTML Format**: `<response question="..." hint="...">content</response>`

**Attributes**:
- `question` - Required, identifies the block
- `hint` - Optional guidance text
- `status` - Managed automatically: `""`, `"loading"`, `"success"`, `"error"`

**Workflow**:
1. Tutor inserts response block via `edit_document`
2. Student writes answer, clicks "Submit for Review"
3. Block enters `loading` state, message sent to tutor
4. Tutor calls `update_response` tool with status
5. Block updates to `success` (locked) or `error` (can retry)

## File Structure

```
src/lib/
├── components/
│   ├── sections/
│   │   ├── chat/          # ChatPanel, ChatInput
│   │   ├── document/      # DocumentEditor, extensions/
│   │   └── views/         # TutoringView
│   ├── ui/                # RetroUI components (Card, Button, etc.)
│   └── renderers/         # Markdown renderer
├── constants/
│   ├── prompts/           # AI system prompts
│   ├── fonts.ts
│   └── startOptions.ts
├── stores/
│   └── sessionStore.svelte.ts
├── tools.ts               # AI tool definitions
├── documentEditor.ts      # applyEdits, updateResponseBlock functions
└── utils.ts
```
